if("undefined"==typeof Promise||Promise.prototype.finally||(Promise.prototype.finally=function(e){const t=this.constructor;return this.then((o=>t.resolve(e()).then((()=>o))),(o=>t.resolve(e()).then((()=>{throw o}))))}),"undefined"!=typeof uni&&uni&&uni.requireGlobal){const e=uni.requireGlobal();ArrayBuffer=e.ArrayBuffer,Int8Array=e.Int8Array,Uint8Array=e.Uint8Array,Uint8ClampedArray=e.Uint8ClampedArray,Int16Array=e.Int16Array,Uint16Array=e.Uint16Array,Int32Array=e.Int32Array,Uint32Array=e.Uint32Array,Float32Array=e.Float32Array,Float64Array=e.Float64Array,BigInt64Array=e.BigInt64Array,BigUint64Array=e.BigUint64Array}uni.restoreGlobal&&uni.restoreGlobal(Vue,weex,plus,setTimeout,clearTimeout,setInterval,clearInterval),function(e){"use strict";function t(e,t,...o){uni.__log__?uni.__log__(e,t,...o):console[e].apply(console,[...o,t])}function o(){try{return uni.getStorageSync("token")||""}catch(e){return""}}function n(e){uni.setStorageSync("token",e)}async function s(e){return await function({url:e,method:s="GET",data:c={},headers:a={}}){const i="object"==typeof c&&null!==c?JSON.stringify(c):c;return new Promise(((c,l)=>{try{uni.request({url:"https://sealos.plumeintel.tech"+e,method:s,data:i,header:{"Content-Type":"application/json",Authorization:o()?`Bearer ${o()}`:"",...a},success:e=>{try{const{statusCode:t,data:o}=e;200===t?c(o):(uni.showToast({title:o&&o.message||"接口错误",icon:"none"}),401===t&&n(""),l(o))}catch(o){t("error","at utils/request.js:56","处理响应时出错:",o),uni.showToast({title:"数据处理错误",icon:"none"}),l(o)}},fail:e=>{uni.showToast({title:"网络异常",icon:"none"}),l(e)}})}catch(r){t("error","at utils/request.js:67","创建请求时出错:",r),uni.showToast({title:"请求创建失败",icon:"none"}),l(r)}}))}({url:`/api/books/${e}/`,method:"GET"})}const c=(e,t)=>{const o=e.__vccOpts||e;for(const[n,s]of t)o[n]=s;return o};__definePage("pages/index/index",c({data:()=>({welcomeVisible:!0,inputMessage:"",messages:[],bookSelected:!1,welcomeOpacity:1,bookInfoOpacity:0,currentBook:{isbn:"",title:"",author:"",publisher:"",introduction:"",coverUrl:""},sseTask:null}),methods:{formatMessage(e){if(!e)return"";if("正在思考..."===e)return`<span style="color:#777;">${e}</span>`;let t=String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");return t=t.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>"),t=t.replace(/\*(.*?)\*/g,"<em>$1</em>"),t=t.replace(/`(.*?)`/g,'<code style="background:#f1f1f1;padding:2px 4px;border-radius:3px;">$1</code>'),t=t.replace(/\n/g,"<br/>"),t},scanISBN(){uni.scanCode({scanType:["barCode"],onlyFromCamera:!1,success:e=>{t("log","at pages/index/index.vue:138","条码类型："+e.scanType),t("log","at pages/index/index.vue:139","条码内容："+e.result),!e.result||10!==e.result.length&&13!==e.result.length?uni.showToast({title:"无效的ISBN码，请重新扫描",icon:"none",duration:2e3}):this.fetchBookInfo(e.result)},fail:e=>{t("error","at pages/index/index.vue:153","扫码失败:",e),uni.showToast({title:"扫码失败，请重试",icon:"none",duration:2e3})},complete:()=>{t("log","at pages/index/index.vue:161","扫码操作完成")}})},manualInput(){uni.showModal({title:"手动输入ISBN",placeholderText:"请输入13位ISBN码",editable:!0,success:e=>{e.confirm&&e.content&&(13===e.content.length||10===e.content.length?this.fetchBookInfo(e.content):uni.showToast({title:"ISBN格式不正确，请输入10位或13位ISBN",icon:"none",duration:2e3}))}})},sendMessage(){if(!this.inputMessage.trim())return;this.messages.push({type:"user",content:this.inputMessage});const e={type:"bot",content:"正在思考..."};this.messages.push(e);const n=this.inputMessage;this.inputMessage="",t("log","at pages/index/index.vue:210","发送消息:",n),t("log","at pages/index/index.vue:211","当前书籍:",this.currentBook);const s=this.messages.slice(0,this.messages.length-1).slice(-10).map((e=>({role:"user"===e.type?"user":"assistant",content:e.content})));t("log","at pages/index/index.vue:222","发送上下文:",s),this.sseTask=function({isbn:e,messages:n,onMessage:s,onError:c,onComplete:a}){t("log","at services/chat.js:14","发送聊天请求:",{isbn:e,messages:n.length});let i=!1;try{const l=uni.request({url:"https://sealos.plumeintel.tech/api/chat/stream/",method:"POST",data:JSON.stringify({isbn:e,messages:n}),header:{"Content-Type":"application/json",Accept:"text/event-stream",Authorization:`Bearer ${o()}`},enableChunked:!0,success:e=>{t("log","at services/chat.js:35","请求完成:",e.statusCode),i||(t("log","at services/chat.js:38","请求正常结束，触发完成回调"),i=!0,a&&a())},fail:e=>{t("error","at services/chat.js:45","请求失败:",e),i=!0,c&&c(e)}});return l.onChunkReceived((e=>{try{let n="";if(e.data instanceof ArrayBuffer){const t=new Uint8Array(e.data);n=decodeURIComponent(escape(String.fromCharCode.apply(null,t)))}else n="string"==typeof e.data?e.data:String(e.data);if(t("log","at services/chat.js:71","收到数据块:",n.substring(0,50)+(n.length>50?"...":"")),n.includes("data:")){const e=n.split(/\r?\n/).filter((e=>e.trim()));for(const n of e){const e=n.trim();if(e)if("data: [DONE]"!==e){if(e.startsWith("data:"))try{const t=e.substring(5).trim(),o=JSON.parse(t);s&&s(o)}catch(o){t("warn","at services/chat.js:99","解析 JSON 失败:",e,o)}}else t("log","at services/chat.js:84","收到完成标记"),i=!0,a&&a()}}else try{const e=JSON.parse(n);s&&s(e)}catch(o){t("warn","at services/chat.js:110","接收到非 JSON 格式数据块:",n)}}catch(o){t("error","at services/chat.js:114","处理数据块时出错:",o)}})),l}catch(l){return t("error","at services/chat.js:121","创建请求时出错:",l),c&&c(l),null}}({isbn:this.currentBook.isbn,messages:s,onMessage:o=>{t("log","at pages/index/index.vue:230","原始收到内容:","object"==typeof o?JSON.stringify(o).substring(0,100):o),"正在思考..."===e.content&&(e.content="");let n="";if(o.choices&&o.choices.length>0){const e=o.choices[0];e.delta&&void 0!==e.delta.content?n=e.delta.content:e.text?n=e.text:e.content?n=e.content:"string"==typeof e&&(n=e),e.content&&"string"==typeof e.content&&(n=e.content)}else o.content?n=o.content:"string"==typeof o&&(n=o);n?(t("log","at pages/index/index.vue:272",`追加文本: "${n}"`),e.content+=n,this.$forceUpdate()):t("warn","at pages/index/index.vue:278","无法从响应提取文本内容:",o)},onError:o=>{t("error","at pages/index/index.vue:282","对话失败:",o),"正在思考..."===e.content?e.content="对话失败，请稍后重试。":e.content+="\n\n[对话中断，请稍后重试]",uni.showToast({title:"对话失败",icon:"none"})},onComplete:()=>{t("log","at pages/index/index.vue:293","对话完成"),"正在思考..."===e.content&&(e.content="抱歉，未能获取到回复内容。"),this.sseTask=null}})},startChat(e){this.inputMessage=e,this.sendMessage()},async fetchBookInfo(e){uni.showLoading({title:"获取书籍信息..."});try{const t=await s(e);this.currentBook={isbn:t.isbn,title:t.title,author:t.author,publisher:t.publisher,introduction:t.introduction,coverUrl:t.cover_url},uni.hideLoading(),this.switchToBookMode()}catch(t){uni.hideLoading(),uni.showToast({title:"获取书籍失败",icon:"none"})}},switchToBookMode(){this.welcomeOpacity=0,setTimeout((()=>{this.bookSelected=!0,setTimeout((()=>{this.bookInfoOpacity=1,this.messages=[{type:"bot",content:`你好，我是《${this.currentBook.title}》的智能助手，请问有什么可以帮助你的吗？`}]}),100)}),300)},cancelBookChat(){this.sseTask&&this.sseTask.abort&&this.sseTask.abort(),this.bookInfoOpacity=0,setTimeout((()=>{this.bookSelected=!1,this.messages=[],setTimeout((()=>{this.welcomeOpacity=1}),100)}),300)},scrollToBottom(){setTimeout((()=>{uni.pageScrollTo({scrollTop:9999,duration:100})}),200)}}},[["render",function(t,o,n,s,c,a){const i=e.resolveComponent("uni-icons");return e.openBlock(),e.createElementBlock("view",{class:"app-container"},[e.createElementVNode("view",{class:"chat-container"},[c.bookSelected?e.createCommentVNode("",!0):(e.openBlock(),e.createElementBlock("view",{key:0,class:"welcome-container",style:e.normalizeStyle({opacity:c.welcomeOpacity})},[e.createElementVNode("image",{class:"welcome-icon",src:"/static/logo.png"}),e.createElementVNode("text",{class:"welcome-title"},"欢迎使用书智对谈"),e.createElementVNode("text",{class:"welcome-text"},"扫描书籍ISBN码或手动输入，开启与书本的智能对话。从此阅读不再枯燥，让AI为你解读书中精彩。"),e.createElementVNode("view",{class:"features"},[e.createElementVNode("view",{class:"feature-item"},[e.createVNode(i,{class:"feature-icon",type:"list",size:"30",color:"#5D5FEF"}),e.createElementVNode("text",{class:"feature-title"},"深度解析"),e.createElementVNode("text",{class:"feature-description"},"智能分析书籍内容，回答深度问题")]),e.createElementVNode("view",{class:"feature-item"},[e.createVNode(i,{class:"feature-icon",type:"chatboxes",size:"30",color:"#5D5FEF"}),e.createElementVNode("text",{class:"feature-title"},"智能对话"),e.createElementVNode("text",{class:"feature-description"},"与书籍进行自然交流，获取洞见")])]),e.createElementVNode("view",{class:"action-buttons"},[e.createElementVNode("button",{class:"action-button",onClick:o[0]||(o[0]=(...e)=>a.scanISBN&&a.scanISBN(...e))},[e.createVNode(i,{class:"action-icon",type:"scan",size:"30",color:"#FFFFFF"}),e.createElementVNode("text",{class:"action-button-title"},"扫描ISBN"),e.createElementVNode("text",{class:"action-button-description"},"快速扫码识别书籍")]),e.createElementVNode("button",{class:"action-button",onClick:o[1]||(o[1]=(...e)=>a.manualInput&&a.manualInput(...e))},[e.createVNode(i,{class:"action-icon",type:"font",size:"30",color:"#FFFFFF"}),e.createElementVNode("text",{class:"action-button-title"},"手动输入"),e.createElementVNode("text",{class:"action-button-description"},"直接输入书籍信息")])])],4)),c.bookSelected?(e.openBlock(),e.createElementBlock("view",{key:1,class:"book-info-container",style:e.normalizeStyle({opacity:c.bookInfoOpacity})},[e.createElementVNode("view",{class:"book-info-content"},[e.createElementVNode("image",{class:"book-cover",src:c.currentBook.coverUrl||"/static/default-book.png"},null,8,["src"]),e.createElementVNode("view",{class:"book-details"},[e.createElementVNode("text",{class:"book-title"},e.toDisplayString(c.currentBook.title),1),e.createElementVNode("text",{class:"book-author"},"作者："+e.toDisplayString(c.currentBook.author),1),e.createElementVNode("text",{class:"book-publisher"},"出版社："+e.toDisplayString(c.currentBook.publisher),1),e.createElementVNode("text",{class:"book-intro-label"},"简介："),e.createElementVNode("text",{class:"book-intro"},e.toDisplayString(c.currentBook.introduction),1)])]),e.createElementVNode("button",{class:"cancel-button",onClick:o[2]||(o[2]=(...e)=>a.cancelBookChat&&a.cancelBookChat(...e))},[e.createElementVNode("text",null,"退出与本书对话")])],4)):e.createCommentVNode("",!0),(e.openBlock(!0),e.createElementBlock(e.Fragment,null,e.renderList(c.messages,((t,o)=>(e.openBlock(),e.createElementBlock("view",{key:o,class:e.normalizeClass(["message","user"===t.type?"message-user":"message-bot"])},["bot"===t.type?(e.openBlock(),e.createElementBlock("rich-text",{key:0,nodes:a.formatMessage(t.content)},null,8,["nodes"])):(e.openBlock(),e.createElementBlock("text",{key:1},e.toDisplayString(t.content),1))],2)))),128))]),e.createElementVNode("view",{class:"input-container"},[e.createElementVNode("button",{class:"function-button"},[e.createVNode(i,{type:"mic-filled",size:"25",color:"#4A4A6A"})]),e.withDirectives(e.createElementVNode("input",{type:"text",class:"chat-input","onUpdate:modelValue":o[3]||(o[3]=e=>c.inputMessage=e),placeholder:"输入问题，与书本对话...",onKeypress:o[4]||(o[4]=e.withKeys(((...e)=>a.sendMessage&&a.sendMessage(...e)),["enter"]))},null,544),[[e.vModelText,c.inputMessage]]),e.createElementVNode("button",{class:"send-button",onClick:o[5]||(o[5]=(...e)=>a.sendMessage&&a.sendMessage(...e))},[e.createVNode(i,{type:"paperplane",size:"20",color:"#FFFFFF"})])])])}]]));const a={async onLaunch(){t("log","at App.vue:8","App Launch");try{await async function(){t("log","at services/auth.js:33","使用模拟登录");const e="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjoxLCJuaWNrbmFtZSI6Iua4uOiLseeUqOaItyJ9.mock_token_for_development";return n(e),{token:e,expires_in:7200,user:{id:1,nickname:"测试用户",avatar_url:"https://thirdwx.qlogo.cn/mmopen/vi_32/mock_avatar/132"}}}()}catch(e){t("error","at App.vue:14","登录失败",e)}},onShow(){t("log","at App.vue:18","App Show")},onHide(){t("log","at App.vue:21","App Hide")}},i=[{font_class:"arrow-down",unicode:""},{font_class:"arrow-left",unicode:""},{font_class:"arrow-right",unicode:""},{font_class:"arrow-up",unicode:""},{font_class:"auth",unicode:""},{font_class:"auth-filled",unicode:""},{font_class:"back",unicode:""},{font_class:"bars",unicode:""},{font_class:"calendar",unicode:""},{font_class:"calendar-filled",unicode:""},{font_class:"camera",unicode:""},{font_class:"camera-filled",unicode:""},{font_class:"cart",unicode:""},{font_class:"cart-filled",unicode:""},{font_class:"chat",unicode:""},{font_class:"chat-filled",unicode:""},{font_class:"chatboxes",unicode:""},{font_class:"chatboxes-filled",unicode:""},{font_class:"chatbubble",unicode:""},{font_class:"chatbubble-filled",unicode:""},{font_class:"checkbox",unicode:""},{font_class:"checkbox-filled",unicode:""},{font_class:"checkmarkempty",unicode:""},{font_class:"circle",unicode:""},{font_class:"circle-filled",unicode:""},{font_class:"clear",unicode:""},{font_class:"close",unicode:""},{font_class:"closeempty",unicode:""},{font_class:"cloud-download",unicode:""},{font_class:"cloud-download-filled",unicode:""},{font_class:"cloud-upload",unicode:""},{font_class:"cloud-upload-filled",unicode:""},{font_class:"color",unicode:""},{font_class:"color-filled",unicode:""},{font_class:"compose",unicode:""},{font_class:"contact",unicode:""},{font_class:"contact-filled",unicode:""},{font_class:"down",unicode:""},{font_class:"bottom",unicode:""},{font_class:"download",unicode:""},{font_class:"download-filled",unicode:""},{font_class:"email",unicode:""},{font_class:"email-filled",unicode:""},{font_class:"eye",unicode:""},{font_class:"eye-filled",unicode:""},{font_class:"eye-slash",unicode:""},{font_class:"eye-slash-filled",unicode:""},{font_class:"fire",unicode:""},{font_class:"fire-filled",unicode:""},{font_class:"flag",unicode:""},{font_class:"flag-filled",unicode:""},{font_class:"folder-add",unicode:""},{font_class:"folder-add-filled",unicode:""},{font_class:"font",unicode:""},{font_class:"forward",unicode:""},{font_class:"gear",unicode:""},{font_class:"gear-filled",unicode:""},{font_class:"gift",unicode:""},{font_class:"gift-filled",unicode:""},{font_class:"hand-down",unicode:""},{font_class:"hand-down-filled",unicode:""},{font_class:"hand-up",unicode:""},{font_class:"hand-up-filled",unicode:""},{font_class:"headphones",unicode:""},{font_class:"heart",unicode:""},{font_class:"heart-filled",unicode:""},{font_class:"help",unicode:""},{font_class:"help-filled",unicode:""},{font_class:"home",unicode:""},{font_class:"home-filled",unicode:""},{font_class:"image",unicode:""},{font_class:"image-filled",unicode:""},{font_class:"images",unicode:""},{font_class:"images-filled",unicode:""},{font_class:"info",unicode:""},{font_class:"info-filled",unicode:""},{font_class:"left",unicode:""},{font_class:"link",unicode:""},{font_class:"list",unicode:""},{font_class:"location",unicode:""},{font_class:"location-filled",unicode:""},{font_class:"locked",unicode:""},{font_class:"locked-filled",unicode:""},{font_class:"loop",unicode:""},{font_class:"mail-open",unicode:""},{font_class:"mail-open-filled",unicode:""},{font_class:"map",unicode:""},{font_class:"map-filled",unicode:""},{font_class:"map-pin",unicode:""},{font_class:"map-pin-ellipse",unicode:""},{font_class:"medal",unicode:""},{font_class:"medal-filled",unicode:""},{font_class:"mic",unicode:""},{font_class:"mic-filled",unicode:""},{font_class:"micoff",unicode:""},{font_class:"micoff-filled",unicode:""},{font_class:"minus",unicode:""},{font_class:"minus-filled",unicode:""},{font_class:"more",unicode:""},{font_class:"more-filled",unicode:""},{font_class:"navigate",unicode:""},{font_class:"navigate-filled",unicode:""},{font_class:"notification",unicode:""},{font_class:"notification-filled",unicode:""},{font_class:"paperclip",unicode:""},{font_class:"paperplane",unicode:""},{font_class:"paperplane-filled",unicode:""},{font_class:"person",unicode:""},{font_class:"person-filled",unicode:""},{font_class:"personadd",unicode:""},{font_class:"personadd-filled",unicode:""},{font_class:"personadd-filled-copy",unicode:""},{font_class:"phone",unicode:""},{font_class:"phone-filled",unicode:""},{font_class:"plus",unicode:""},{font_class:"plus-filled",unicode:""},{font_class:"plusempty",unicode:""},{font_class:"pulldown",unicode:""},{font_class:"pyq",unicode:""},{font_class:"qq",unicode:""},{font_class:"redo",unicode:""},{font_class:"redo-filled",unicode:""},{font_class:"refresh",unicode:""},{font_class:"refresh-filled",unicode:""},{font_class:"refreshempty",unicode:""},{font_class:"reload",unicode:""},{font_class:"right",unicode:""},{font_class:"scan",unicode:""},{font_class:"search",unicode:""},{font_class:"settings",unicode:""},{font_class:"settings-filled",unicode:""},{font_class:"shop",unicode:""},{font_class:"shop-filled",unicode:""},{font_class:"smallcircle",unicode:""},{font_class:"smallcircle-filled",unicode:""},{font_class:"sound",unicode:""},{font_class:"sound-filled",unicode:""},{font_class:"spinner-cycle",unicode:""},{font_class:"staff",unicode:""},{font_class:"staff-filled",unicode:""},{font_class:"star",unicode:""},{font_class:"star-filled",unicode:""},{font_class:"starhalf",unicode:""},{font_class:"trash",unicode:""},{font_class:"trash-filled",unicode:""},{font_class:"tune",unicode:""},{font_class:"tune-filled",unicode:""},{font_class:"undo",unicode:""},{font_class:"undo-filled",unicode:""},{font_class:"up",unicode:""},{font_class:"top",unicode:""},{font_class:"upload",unicode:""},{font_class:"upload-filled",unicode:""},{font_class:"videocam",unicode:""},{font_class:"videocam-filled",unicode:""},{font_class:"vip",unicode:""},{font_class:"vip-filled",unicode:""},{font_class:"wallet",unicode:""},{font_class:"wallet-filled",unicode:""},{font_class:"weibo",unicode:""},{font_class:"weixin",unicode:""}];const l=c({name:"UniIcons",emits:["click"],props:{type:{type:String,default:""},color:{type:String,default:"#333333"},size:{type:[Number,String],default:16},customPrefix:{type:String,default:""},fontFamily:{type:String,default:""}},data:()=>({icons:i}),computed:{unicode(){let e=this.icons.find((e=>e.font_class===this.type));return e?e.unicode:""},iconSize(){return"number"==typeof(e=this.size)||/^[0-9]*$/g.test(e)?e+"px":e;var e},styleObj(){return""!==this.fontFamily?`color: ${this.color}; font-size: ${this.iconSize}; font-family: ${this.fontFamily};`:`color: ${this.color}; font-size: ${this.iconSize};`}},methods:{_onClick(){this.$emit("click")}}},[["render",function(t,o,n,s,c,a){return e.openBlock(),e.createElementBlock("text",{style:e.normalizeStyle(a.styleObj),class:e.normalizeClass(["uni-icons",["uniui-"+n.type,n.customPrefix,n.customPrefix?n.type:""]]),onClick:o[0]||(o[0]=(...e)=>a._onClick&&a._onClick(...e))},[e.renderSlot(t.$slots,"default",{},void 0,!0)],6)}],["__scopeId","data-v-dae1b464"]]);const{app:r,Vuex:d,Pinia:u}=function(){const t=e.createVueApp(a);return t.component("uni-icons",l),{app:t}}();uni.Vuex=d,uni.Pinia=u,r.provide("__globalStyles",__uniConfig.styles),r._component.mpType="app",r._component.render=()=>{},r.mount("#app")}(Vue);
